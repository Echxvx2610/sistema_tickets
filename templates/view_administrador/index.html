{% extends "base/layout.html" %}
{% block title %}Gestión de Tickets{% endblock %}
<!-- Estilos Locales -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

{% block content %}
<div class="dashboard-container">
    <!-- Bienvenida y Filtros -->
    <div class="welcome-section">
        <h1>Bienvenido(a) {{ current_user.nombre if current_user else 'Usuario' }}.</h1>

        <div class="filter-options">
            <label class="filter-option">
                <input type="radio" name="status-filter" value="all" checked>
                <span>Todos</span>
            </label>
            <label class="filter-option">
                <input type="radio" name="status-filter" value="pending">
                <span>Pendientes</span>
            </label>
            <label class="filter-option">
                <input type="radio" name="status-filter" value="in-progress">
                <span>En Proceso</span>
            </label>
            <label class="filter-option">
                <input type="radio" name="status-filter" value="completed">
                <span>Completados</span>
            </label>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Controles de la tabla -->
    <div class="table-controls">
        <div class="entries-control">
            Mostrar
            <select class="form-select form-select-sm" aria-label="Registros por página">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            registros
        </div>
        <div class="search-control">
            <input type="search" class="form-control" placeholder="Filtrar...">
        </div>
    </div>

    <!-- Tabla de Tickets -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Turno</th>
                    <th>Fecha</th>
                    <th>Área</th>
                    <th>Celda</th>
                    <th>Problema</th>
                    <th>Usuario</th>
                    <th>Técnico</th>
                    <th>Servicio</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td>{{ ticket.id }}</td>
                    <td>{{ ticket.turno }}</td>
                    <td>{{ ticket.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <!-- Asegúrate de que la fecha sea un objeto datetime o usar un formato adecuado -->
                    <td>{{ ticket.area }}</td>
                    <td>{{ ticket.celda }}</td>
                    <td>{{ ticket.titulo }}</td>
                    <td>{{ ticket.username }}</td>
                    <td>{{ ticket.tecnico_id or 'Sin asignar' }}</td>
                    <td>{{ ticket.tipo_servicio }}</td>
                    <td>
                        <span class="status-badge status-{{ ticket.estado.lower().replace(' ', '-') }}">
                            {{ ticket.estado }}
                        </span>
                    </td>
                    <td class="actions">
                        <div class="btn-group">
                            <button
                                onclick="openUpdateModal({{ ticket.id }}, '{{ ticket.titulo }}', '{{ ticket.descripcion }}', '{{ ticket.estado }}', '{{ ticket.username }}')"
                                class="btn btn-sm btn-outline-primary" title="Editar ticket">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button onclick="confirmDelete({{ ticket.id }})" class="btn btn-sm btn-outline-danger"
                                title="Eliminar ticket">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="text-center">No hay tickets disponibles.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para actualizar ticket -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Actualizar Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateForm" method="POST" action="">
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título:</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción:</label>
                        <textarea class="form-control" id="descripcion" name="descripcion" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado:</label>
                        <select class="form-select" id="estado" name="estado" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Completado">Completado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="usuario_id" class="form-label">ID Usuario:</label>
                        <input type="number" class="form-control" id="usuario_id" name="usuario_id" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary"
                    onclick="document.getElementById('updateForm').submit()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openUpdateModal(ticketId, titulo, descripcion, estado, usuarioId) {
        // Establecer la acción del formulario
        document.getElementById('updateForm').action = `/update_ticket/${ticketId}`;

        // Actualizar el título del modal
        document.getElementById('modalTitle').textContent = `Actualizar Ticket #${ticketId}`;

        // Cargar los datos actuales del ticket en el formulario
        document.getElementById('titulo').value = titulo;
        document.getElementById('descripcion').value = descripcion;
        document.getElementById('estado').value = estado;
        document.getElementById('usuario_id').value = usuarioId;

        // Mostrar el modal usando Bootstrap
        const myModal = new bootstrap.Modal(document.getElementById('updateModal'));
        myModal.show();
    }

    // No necesitas las funciones closeModal, ya que Bootstrap maneja eso automáticamente

    // Cerrar modal cuando se hace clic fuera de él
    window.onclick = function (event) {
        const modal = document.getElementById('updateModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // Cerrar modal con la X
    document.querySelector('.close').onclick = closeModal;

    function confirmDelete(ticketId) {
        if (confirm('¿Estás seguro de que deseas eliminar este ticket?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_ticket/${ticketId}`;
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Cerrar modal cuando se hace clic fuera de él
    window.onclick = function (event) {
        const modal = document.getElementById('updateModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // Cerrar modal con la X
    document.querySelector('.close').onclick = closeModal;
</script>
{% endblock %}